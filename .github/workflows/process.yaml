name: Process
on:
  workflow_dispatch:
  schedule:
    - cron: "05 03 * * *"
    - cron: "05 11 * * *"

env:
  # äº§ç‰©æ–‡ä»¶è·¯å¾„ï¼›ä¸åœ¨æ ¹ç›®å½•å°±æ”¹è¿™é‡Œï¼ˆä¾‹å¦‚ build/clash.yamlï¼‰
  OUTPUT_FILE: clash.yaml

jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Prepare
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"
          cache: "pip"

      - name: Install
        run: pip3 install -r requirements.txt

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # è‡ªæ£€ï¼šSecrets éç©º
      - name: Validate secrets (non-empty)
        env:
          GIST_LINK: ${{ secrets.GIST_LINK }}   # å¯å¡« ID æˆ–å®Œæ•´ URL
          GIST_PAT:  ${{ secrets.GIST_PAT }}    # éœ€è¦ Gists: Read & write
        run: |
          set -eux
          test -n "$GIST_LINK" || (echo "GIST_LINK is empty"; exit 1)
          test -n "$GIST_PAT"  || (echo "GIST_PAT is empty";  exit 1)

      # å¤åˆ¶é»˜è®¤é…ç½®å¹¶æ³¨å…¥ Gist æ¨é€ï¼ˆåŒ¹é… storage.items["xxx-clash"]ï¼‰
      - name: Build runtime config.json (inject push->gist)
        env:
          GIST_LINK: ${{ secrets.GIST_LINK }}
          GIST_PAT:  ${{ secrets.GIST_PAT }}
          OUTPUT_FILE: ${{ env.OUTPUT_FILE }}
        run: |
          set -eux
          test -f subscribe/config/config.default.json
          cp subscribe/config/config.default.json config.json

          # æ”¯æŒ GIST_LINK=URL æˆ– IDï¼Œç»Ÿä¸€æå– ID
          RAW="$GIST_LINK"
          if echo "$RAW" | grep -qi '^http'; then
            GID="$(echo "$RAW" | sed 's#/*$##' | awk -F/ '{print $NF}')"
          else
            GID="$RAW"
          fi

          # æ³¨å…¥ gist æ¨é€ï¼›å…³é”®æ˜¯æŠŠ items é‡Œçš„ "xxx-clash" æŒ‡åˆ° OUTPUT_FILE
          jq --arg id "$GID" --arg tok "$GIST_PAT" --arg fn "$OUTPUT_FILE" '
            .storage.engine = "gist" |
            .storage.base   = "https://api.github.com" |
            .storage.domain = "https://gist.github.com" |
            .storage.token  = $tok |
            .storage.items  = (
              .storage.items // {} |
              . + { "xxx-clash": { "id": $id, "filename": $fn } }
            )
          ' config.json > config.tmp && mv config.tmp config.json

          echo "=== RESOLVED config.json (token redacted) ==="
          jq '.storage.token="***" | .storage' config.json

      # ç”¨ SUBSCRIBE_CONF + -c è¿è¡Œï¼ˆè„šæœ¬ä¸æ”¯æŒ --configï¼‰
      - name: Process
        env:
          SUBSCRIBE_CONF: config.json
        run: |
          set -eux
          python -u subscribe/process.py -c --overwrite

      # æ–­è¨€äº§ç‰©å­˜åœ¨ï¼›å¦‚æœè·¯å¾„ä¸å¯¹ä¼šæ˜ç¡®æŠ¥é”™
      - name: Verify output exists
        env:
          OUTPUT_FILE: ${{ env.OUTPUT_FILE }}
        run: |
          set -eux
          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "ERROR: Output file not found: $OUTPUT_FILE"
            echo "ğŸ‘‰ å¦‚æœè„šæœ¬æŠŠæ–‡ä»¶å†™åœ¨åˆ«çš„ç›®å½•ï¼Œè¯·æ”¹æœ¬æ–‡ä»¶é¡¶éƒ¨çš„ OUTPUT_FILE"
            exit 1
          fi
          echo "Found: $OUTPUT_FILE"
          ls -al "$OUTPUT_FILE"

      - name: Timestamp
        run: date
